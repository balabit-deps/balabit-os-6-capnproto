From 51e801a705b1cf40eb3d21f9dd2038edba4d8b2e Mon Sep 17 00:00:00 2001
From: Kenton Varda <kenton@sandstorm.io>
Date: Sat, 15 Apr 2017 19:31:53 -0700
Subject: [PATCH] SECURITY: Prevent compiler from eliding bounds checks.

Details: https://github.com/sandstorm-io/capnproto/blob/master/security-advisories/2017-04-17-0-apple-32bit-elides-bounds-check.md
---
 src/capnp/arena.h | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/src/capnp/arena.h b/src/capnp/arena.h
index 53e17c0c..4c58af45 100644
--- a/src/capnp/arena.h
+++ b/src/capnp/arena.h
@@ -302,7 +302,11 @@ inline SegmentReader::SegmentReader(Arena* arena, SegmentId id, kj::ArrayPtr<con
     : arena(arena), id(id), ptr(ptr), readLimiter(readLimiter) {}
 
 inline bool SegmentReader::containsInterval(const void* from, const void* to) {
-  return from >= this->ptr.begin() && to <= this->ptr.end() && from <= to &&
+  uintptr_t start = reinterpret_cast<uintptr_t>(from) - reinterpret_cast<uintptr_t>(ptr.begin());
+  uintptr_t end = reinterpret_cast<uintptr_t>(to) - reinterpret_cast<uintptr_t>(ptr.begin());
+  uintptr_t bound = ptr.size() * sizeof(capnp::word);
+
+  return start <= bound && end <= bound && start <= end &&
       readLimiter->canRead(
           intervalLength(reinterpret_cast<const byte*>(from),
                          reinterpret_cast<const byte*>(to)) / BYTES_PER_WORD,
-- 
2.17.1

